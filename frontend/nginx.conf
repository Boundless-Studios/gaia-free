server {
    listen ${PORT};
    server_name _;

    # Use Google's DNS resolver (8.8.8.8) for dynamic upstream resolution
    # This prevents nginx from failing at startup if upstreams are unavailable
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 10s;

    root /usr/share/nginx/html;
    index index.html;

    # Serve static files with proper MIME types
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Cache static assets
    location /assets/ {
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    location /api/ {
        set $backend_scheme "${BACKEND_SCHEME}";
        set $backend_host "${BACKEND_HOST}";
        proxy_pass $backend_scheme://$backend_host$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $backend_host;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_ssl_name $backend_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_buffering off;
    }

    # Proxy WebSocket connections
    location /ws/ {
        set $backend_scheme "${BACKEND_SCHEME}";
        set $backend_host "${BACKEND_HOST}";
        proxy_pass $backend_scheme://$backend_host$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $backend_host;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_ssl_name $backend_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }

    # Proxy Socket.IO connections (used by game real-time features)
    location /socket.io/ {
        set $backend_scheme "${BACKEND_SCHEME}";
        set $backend_host "${BACKEND_HOST}";
        proxy_pass $backend_scheme://$backend_host$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $backend_host;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_ssl_name $backend_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_buffering off;
    }

    # Proxy STT (Speech-to-Text) requests to STT service
    # STT_PROXY_START
    location /stt/ {
        set $stt_scheme "${STT_SCHEME}";
        set $stt_host "${STT_HOST}";
        proxy_pass $stt_scheme://$stt_host$request_uri;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $stt_host;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_ssl_name $stt_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
        proxy_buffering off;
    }
    # STT_PROXY_END
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
